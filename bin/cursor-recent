#!/usr/bin/env bash
set -euo pipefail

state="$HOME/.cursor/ide_state.json"
if [[ ! -f "$state" ]]; then
  echo "cursor recent state not found: $state" >&2
  exit 1
fi

base="$HOME/Projects/Qlj"

list="$(BASE="$base" python3 - <<'PY'
import json, os
state = os.path.expanduser('~/.cursor/ide_state.json')
base = os.path.expanduser(os.environ.get('BASE', '~/Projects/Qlj'))
base = os.path.normpath(base)

with open(state, 'r', encoding='utf-8') as f:
    data = json.load(f)

items = data.get('recentlyViewedFiles', [])
seen = set()
order = []

for it in items:
    p = it.get('absolutePath')
    if not p:
        continue
    p = os.path.normpath(p)
    if not p.startswith(base + os.sep):
        continue
    rest = p[len(base)+1:]
    top = rest.split(os.sep, 1)[0]
    if not top:
        continue
    root = os.path.join(base, top)
    if not os.path.isdir(root):
        continue
    if root not in seen:
        seen.add(root)
        order.append(root)

try:
    all_entries = [os.path.join(base, d) for d in os.listdir(base)]
except FileNotFoundError:
    all_entries = []

for p in sorted(all_entries):
    if not os.path.isdir(p):
        continue
    if p not in seen:
        seen.add(p)
        order.append(p)

for p in order:
    name = os.path.basename(p)
    print(f"{name}\t{p}")
PY
)"

if [[ -z "${list}" ]]; then
  echo "No recent projects found in Cursor state." >&2
  exit 1
fi

if ! command -v fzf >/dev/null 2>&1; then
  echo "fzf not found in PATH. Please install fzf first." >&2
  exit 1
fi

choice="$(printf '%s\n' "$list" | fzf --prompt='Cursor Recent > ' --height=40% --reverse --no-sort --with-nth=1 --delimiter=$'\\t')"

if [[ -z "${choice}" ]]; then
  echo "No selection." >&2
  exit 1
fi

choice_path="${choice#*$'\\t'}"
if [[ -z "${choice_path}" ]]; then
  echo "Invalid selection." >&2
  exit 1
fi

if command -v cursor >/dev/null 2>&1; then
  exec cursor "$choice_path"
elif command -v code >/dev/null 2>&1; then
  exec code "$choice_path"
else
  echo "Neither 'cursor' nor 'code' found in PATH." >&2
  exit 1
fi
